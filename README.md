# PatchCore for Anomaly Detection on KSDD2 Dataset

This project implements and evaluates PatchCore, a state-of-the-art anomaly detection method, on the Kolektor Surface Defect Dataset 2 (KSDD2). It includes options for using single or dual memory banks and incorporating augmented defect data generated by diffusion models.

## Core Components

### 1. PatchCore Implementation (`patchcore.py`)

This file contains the core logic for the PatchCore algorithm.

-   **`PatchCoreSingle`**: Implements PatchCore with a single memory bank, typically trained on normal (defect-free) samples.
-   **`PatchCoreDual`**: Extends PatchCore to use two memory banks:
    -   A **negative memory bank** built from normal samples.
    -   A **positive memory bank** built from anomalous (defective) samples. This can include pre-cropped defects and optionally, synthetically generated defects.
-   **Feature Extraction**: Utilizes pre-trained ResNet50 or WideResNet50_2 models as backbones to extract patch-level features from input images.
-   **Coreset Subsampling**: Employs coreset subsampling to reduce the size of the memory bank(s), improving efficiency while retaining representative features.
-   **Anomaly Scoring**:
    -   For a given test sample, features are extracted and compared against the memory bank(s).
    -   An anomaly score is calculated based on the distance to the nearest neighbors in the feature space.
    -   For `PatchCoreDual`, the scores from both positive and negative banks are combined.
-   **Localization**: Generates anomaly maps to highlight defective regions in images.

### 2. Experiment Runner (`run_patchcore.py`)

This script orchestrates the training, evaluation, and experimentation process.

-   **Data Handling**:
    -   Loads the KSDD2 dataset using custom `Dataset` classes (`data/ksdd2.py` and `data/ksdd2_crops.py`).
    -   `KolektorSDD2`: Handles loading of the standard KSDD2 dataset.
    -   `KolektorSDD2Crops`: Specifically loads pre-cropped defect images, which can be augmented.
-   **Model Configuration**:
    -   Allows selection of the backbone network (ResNet50, WideResNet50_2).
    -   Configures subsampling rates for the memory bank(s).
    -   Supports enabling/disabling the use of augmented defect data.
-   **Training**: Fits the selected PatchCore model (`PatchCoreSingle` or `PatchCoreDual`) using the specified training data.
-   **Evaluation**:
    -   Evaluates the trained model on a test set.
    -   Calculates image-level and pixel-level Area Under the Receiver Operating Characteristic curve (AUROC) scores.
-   **Results**: Saves evaluation metrics to a `.npy` file.

### 3. Data Acquisition and Preprocessing

-   **`ksdd2_downloader.py`**: Script to download the KSDD2 dataset.
-   **`ksdd2_preprocess.py`**: Script for preprocessing the KSDD2 dataset. (Further details on preprocessing steps would typically be found within this script's comments or documentation).

### 4. Data Augmentation (`generate_augmented_images.py`)

-   This script is responsible for generating synthetic defect images using diffusion models.
-   The augmented images can be incorporated into the positive memory bank of the `PatchCoreDual` model to potentially improve its ability to detect diverse defects.

## Dataset

The project utilizes the **Kolektor Surface Defect Dataset 2 (KSDD2)**, which contains images of industrial surfaces with and without defects.

-   **Normal Data**: Images without any defects.
-   **Anomalous Data**: Images with various types of surface defects.
    -   The project uses pre-cropped defect regions for building the positive memory bank.

## Usage

1.  **Setup Environment**:
    ```bash
    pip install -r requirements.txt
    ```
2.  **Download Data**:
    ```bash
    python ksdd2_downloader.py
    ```
3.  **Preprocess Data**:
    ```bash
    python ksdd2_preprocess.py
    ```
    *(Ensure paths and parameters within the script are set correctly).*
4.  **(Optional) Generate Augmented Images**:
    ```bash
    python generate_augmented_images.py --output_path <path_to_save_augmented_images>
    ```
    *(Refer to the script for more detailed arguments on diffusion model configuration, number of images, etc.)*
5.  **Run PatchCore Experiments**:
    ```bash
    python run_patchcore.py \
        --dataset_path <path_to_ksdd2_dataset> \
        --crops_path <path_to_pre_cropped_defects> \
        --output_dir ./results \
        --backbone resnet50 \ # or wide_resnet50_2
        # --add_augmented \ # Uncomment to use augmented images
        # --augmented_path <path_to_augmented_images> \ # Specify if using augmented images
        --neg_subsampling 0.01 \
        --pos_subsampling 0.10 \
        --seed 42
    ```
    Refer to `run_patchcore.py` for the full list of command-line arguments and their descriptions.

## Key Features and Contributions

-   Implementation of both `PatchCoreSingle` and `PatchCoreDual`.
-   Integration with the KSDD2 dataset.
-   Ability to leverage pre-cropped defects for the positive memory bank.
-   Framework for incorporating diffusion-based data augmentation for defect synthesis.
-   Systematic evaluation of anomaly detection performance using image and pixel-level AUROC.

## Future Work / Potential Enhancements

-   Explore different backbone architectures.
-   Investigate various coreset subsampling strategies.
-   Experiment with different diffusion models and augmentation techniques.
-   Extend to other anomaly detection datasets.
-   Optimize inference speed for real-time applications.
